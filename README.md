# テキスト処理パイプライン: FineWeb サンプル

このプロジェクトは、[FineWeb](https://huggingface.co/datasets/HuggingFaceFW/fineweb) データセットのサンプルテキストを処理するPythonパイプラインです。主な処理は、HojiCharによるテキストのクリーニング（フィルタリング）と、事前学習済みTransformerモデルによる教育コンテンツとしての品質スコアリングです。

## 主な機能

- **多段階処理**: データの読み込み、フィルタリング、スコアリングを段階的に実行します。
- **テキストフィルタリング**:
    - `HojiChar`ライブラリを利用し、テキストの正規化や不要な文字の除去を行います。
    - CPUのマルチコアを活用した並列処理により、大量のデータを高速に処理します。
- **AIによるテキストスコアリング**:
    - Hugging Faceの`hotchpotch/fineweb-2-edu-japanese-classifier`モデルを使用し、テキストが教育的な内容かを判定・スコアリングします。
    - `transformers`と`torch`を基盤とし、利用可能な場合はGPU（CUDA）を自動で検知・使用します（GPUがない場合はCPUにフォールバック）。
    - 依存ライブラリ（`torch`など）がない場合、このステップは安全にスキップされます。
- **堅牢な設計**:
    - 処理の進捗やエラーをコンソールとログファイル（`pipeline.log`）に出力します。
    - ファイルI/Oやメモリ関連のエラーを適切にハンドリングし、予期せぬ中断を防ぎます。

## パイプラインの処理フロー

メインスクリプト `main.py` は、以下の順序で処理を調整します。

1.  **データ読み込み**
    - 入力: `docs/fineweb_100_samples.json`
    - ファイルからテキストデータを抽出します。
    ↓
2.  **フィルタリング (CPU)**
    - HojiCharを使い、テキストをクリーニングします。
    - 中間出力: `filtered_texts.jsonl`
    ↓
3.  **スコアリング (GPU/CPU)**
    - フィルタリング済みのテキストをAIモデルで評価します。
    ↓
4.  **最終出力**
    - 出力: `scored_texts.jsonl`
    - 元のテキスト、教育的かどうかの判定（`is_educational`）、スコア（`score`）をJSONL形式で保存します。

## 依存関係

パイプラインの各ステップを実行するには、以下のライブラリが必要です。

- **テキストフィルタリング用**:
  ```bash
  pip install hojichar==0.9.0
  ```

- **データ取得・処理用**:
  (データ再生成や一部スクリプトのテスト実行に必要)
  ```bash
  pip install datasets pandas
  ```

- **テキストスコアリング用**:
  ```bash
  pip install torch transformers scikit-learn sentencepiece accelerate protobuf
  ```
  **注記**: PyTorch (`torch`) は、特にGPU（CUDA）サポート付きの場合、ファイルサイズが非常に大きくなることがあります。CPU専用でインストールする場合は、[公式PyTorchインストールガイド](https://pytorch.org/get-started/locally/) を参照し、適切なコマンドを使用してください（例: `--index-url https://download.pytorch.org/whl/cpu`）。

## 実行方法

1.  **依存関係のインストール**: 上記のコマンドで必要なライブラリをインストールします。

2.  **データファイルの準備**: スクリプトは `docs/fineweb_100_samples.json` を使用します。このファイルが存在しない場合は、以下のコマンドで生成してください。
    ```bash
    python サンプルで100件取得する.py
    ```

3.  **メインパイプラインの実行**: 以下のコマンドでパイプラインを開始します。
    ```bash
    python main.py
    ```
    スクリプトは各ステップの進捗をコンソールに出力します。スコアリング用のライブラリが不足している場合、そのステップはスキップされます。

## 生成されるファイル

このプロジェクトでは、実行するスクリプトに応じて以下のファイルが生成されます。

- **`docs/fineweb_100_samples.json`**:
  - パイプラインの**入力データ**です。
  - `サンプルで100件取得する.py` を実行することで生成されます。

- **`pipeline.log`**:
  - `main.py` の実行ログ。デバッグや処理の追跡に役立ちます。

- **`filtered_texts.jsonl`**:
  - `main.py` によって生成される**中間ファイル**。HojiCharでクリーニングされたテキストデータが含まれます（JSONL形式）。

- **`scored_texts.jsonl`**:
  - `main.py` によって生成される**最終出力ファイル**。スコアリング結果が含まれます（JSONL形式）。このファイルは、スコアリングステップが正常に実行された場合にのみ生成されます。
```
